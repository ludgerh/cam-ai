{% extends 'main/basis.html' %}
{% comment %}
Copyright (C) 2024-2025 by the CAM-AI team, info@cam-ai.de
More information and complete source: https://github.com/ludgerh/cam-ai
This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 3
of the License, or (at your option) any later version.
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
See the GNU General Public License for more details.
You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
{% endcomment %}
{% block content %}
{% if emulatestatic %}
  {% load static %}
  <script src="{% static 'camai/git/js/wstools.js' %}"></script>
  <script src="{% static 'camai/nogit/js/jquery-3.5.1.js' %}"></script>
{% else %}
  <script src="https://static.cam-ai.de/{{ version }}/camai/git/js/wstools.js"></script>
  <script src="https://static.cam-ai.de/{{ version }}/camai/nogit/js/jquery-3.5.1.min.js"></script>
{% endif %}
  
<main>
  <div id="phase0"> 
    <div class="h2">
      Select the backup ZIP file you want to upload to this server.
    </div> 
    <form class="h2" id="upload-form">
      {% csrf_token %}
      <input id="fileselector" type="file" name="myfile">
      <button id="upload-btn" type="submit">Upload</button>
    </form>
    <div class="h2" id="upload-status"></div>
  </div> 
  <div id="phase1" class="d-none"> 
    <div class="h2">
      We received the ZIP File. Select what you want to import:<BR>
    </div> 
    <form class="h2" action="{% url 'tools:process_restore' %}" 
        id="import-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="job_type" value="restore">
      <input type="hidden" name="file_name" value="?">
      <input type="hidden" name="status" value="?">
      <input type="checkbox" id="check_files" name="check_files" checked>
      Import files?<BR>
      <input type="checkbox" id="check_db" name="check_db" checked>
      Import database content?<BR><BR>
      Important: Only click import, if you know what you are doing.
      The process will overwrite your CAM-AI servers data!
      <button id="import-btn" type="submit">Import</button>
    </form>
    <div class="h2 d-none" id="line2">
      Processing the upload. Please wait...
    </div>  
  </div> 
  
</main>
  
<script>

let tools_asyncSocket;

$(document).ready(function() {
  const upload_socket = new WebSocket(ws_scheme + '//'
    + window.location.host
    + '/ws/uploads/')
  const CHUNK_SIZE = 1024 * 1024;
  $('#upload-form').on('submit', async function (e) {
    e.preventDefault();
    const fileInput = document.getElementById('fileselector');
    const file = fileInput.files[0];
    if (!file) return;
    $('#upload-btn').prop('disabled', true);
    $('#upload-status').text('Starting upload...');
    upload_socket.send(JSON.stringify({
      command: 'upload_start',
      filename: file.name,
      size: file.size,
    }));
    let result = JSON.parse(await nextMessage(upload_socket));
    if (!result || result.status !== 'OK') {
      $('#upload-status').text('Error during upload_start: ' 
        + (result && result.message ? result.message : ''));
      return;
    } 
    upload_socket.onmessage = async function(e) {
      result = e.data;
      if (result == 'Done!'){
        upload_socket.onmessage = null;
        upload_socket.send(JSON.stringify({
          command: 'upload_finish',
          filename: file.name,
        }));
        result = JSON.parse(await nextMessage(upload_socket));
        if (result && result.status === 'OK') {
          $('#import-form input[name="file_name"]').val(file.name);
          $('#phase0').addClass('d-none');
          $('#phase1').removeClass('d-none');
        } else {
          $('#upload-status').text('Error during upload_finish: ' 
            + (result && result.message ? result.message : ''));
        }
      } else {
        $('#upload-status').text('Upload: ' + result);
      };
    };  
    let offset = 0;
    while (offset < file.size) {
      const slice = file.slice(offset, offset + CHUNK_SIZE);
      const buffer = await slice.arrayBuffer();
      upload_socket.send(buffer);
      offset += CHUNK_SIZE;
    };
  });
  $('#import-form').on('submit', function (e) {
    e.preventDefault();
    const form = this;
    $('#line2').removeClass('d-none');
    $('#import-btn').prop('disabled', true);
    $('#import-form input[name="status"]').val('OK');
    form.submit();
  });
});

</script>  

{% endblock %}

